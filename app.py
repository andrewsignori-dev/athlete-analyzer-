import streamlit as st
import pandas as pd
import seaborn as sns
import matplotlib.pyplot as plt
from sklearn.preprocessing import StandardScaler
import numpy as np

# Load dataset
df = pd.read_excel("synthetic_athlete_dataset.xlsx")

# List of ability columns
abilities = ["Speed", "Endurance", "Strength", "Agility", "ReactionTime"]

# Standardize abilities
scaler = StandardScaler()
df_scaled = df.copy()
df_scaled[abilities] = scaler.fit_transform(df[abilities])

# Sidebar page selection
st.sidebar.title("Navigation")
page = st.sidebar.radio("Go to", ["Dashboard", "Raw Data"])

# Sidebar filters (common)
st.sidebar.header("Filter Athletes")
gender_options = ["All"] + df_scaled["Gender"].unique().tolist()
selected_gender = st.sidebar.selectbox("Select Gender", gender_options)

sport_options = ["All"] + df_scaled["Sport"].unique().tolist()
selected_sport = st.sidebar.selectbox("Select Sport", sport_options)

min_age, max_age = int(df_scaled["Age"].min()), int(df_scaled["Age"].max())
selected_age = st.sidebar.slider("Select Age Range", min_age, max_age, (min_age, max_age))

# Apply filters
filtered_df = df_scaled.copy()
if selected_gender != "All":
    filtered_df = filtered_df[filtered_df["Gender"] == selected_gender]
if selected_sport != "All":
    filtered_df = filtered_df[filtered_df["Sport"] == selected_sport]
filtered_df = filtered_df[(filtered_df["Age"] >= selected_age[0]) & (filtered_df["Age"] <= selected_age[1])]

# ---------------------------
# Page 1: Dashboard (plots)
# ---------------------------
if page == "Dashboard":
    st.title("Athlete Abilities Dashboard (Standardized)")

    # ---------------------------
    # Create plot figures and descriptions
    # ---------------------------
    plots = []

    # 1. Bar plot
    avg_values = filtered_df[abilities].mean()
    colors = ["#2ca02c" if v >= 0 else "#d62728" for v in avg_values]
    fig_bar, ax_bar = plt.subplots(figsize=(6,5))
    sns.barplot(x=avg_values.index, y=avg_values.values, palette=colors, ax=ax_bar)
    ax_bar.axhline(0, color="black", linestyle="--")
    ax_bar.set_ylabel("Z-score")
    fig_bar.tight_layout()
    plots.append((fig_bar, "**Bar Plot:** Average abilities. Green = above avg, Red = below avg."))

    # 2. Box plot
    melted = filtered_df.melt(id_vars=["AthleteID"], value_vars=abilities, var_name="Ability", value_name="Z-Score")
    fig_box, ax_box = plt.subplots(figsize=(6,5))
    sns.boxplot(x="Ability", y="Z-Score", data=melted, palette="coolwarm", ax=ax_box)
    ax_box.axhline(0, color="black", linestyle="--")
    fig_box.tight_layout()
    plots.append((fig_box, "**Box Plot:** Distribution of abilities, 0 = overall avg."))

    # 3. Pie chart
    counts = filtered_df["Gender"].value_counts()
    fig_pie, ax_pie = plt.subplots(figsize=(5,5))
    ax_pie.pie(counts, labels=counts.index, autopct="%1.1f%%", colors=sns.color_palette("Set2"))
    fig_pie.tight_layout()
    plots.append((fig_pie, "**Pie Chart:** Gender distribution."))

    # 4. Heatmap
    corr = filtered_df[abilities].corr()
    fig_corr, ax_corr = plt.subplots(figsize=(6,5))
    sns.heatmap(corr, annot=True, cmap="coolwarm", ax=ax_corr)
    fig_corr.tight_layout()
    plots.append((fig_corr, "**Heatmap:** Correlation between abilities."))

    # 5. Radar chart
    avg_values_radar = filtered_df[abilities].mean().values
    num_vars = len(abilities)
    angles = np.linspace(0, 2 * np.pi, num_vars, endpoint=False).tolist()
    avg_values_loop = np.concatenate((avg_values_radar, [avg_values_radar[0]]))
    angles_loop = angles + angles[:1]

    fig_radar, ax_radar = plt.subplots(figsize=(6,6), subplot_kw=dict(polar=True))
    ax_radar.plot(angles_loop, avg_values_loop, color="blue", linewidth=2)
    ax_radar.fill(angles_loop, avg_values_loop, color="skyblue", alpha=0.25)
    ax_radar.set_xticks(angles)
    ax_radar.set_xticklabels(abilities)
    ax_radar.axhline(0, color="grey", linestyle="--")
    fig_radar.tight_layout()
    plots.append((fig_radar, "**Radar Chart:** Overall ability profile."))

    # ---------------------------
    # Display plots in responsive grid
    # ---------------------------
    st.subheader("Visualizations")
    n_cols = 3  # number of columns per row
    for i in range(0, len(plots), n_cols):
        cols = st.columns(n_cols)
        for j, (fig, desc) in enumerate(plots[i:i+n_cols]):
            with cols[j]:
                st.pyplot(fig)
                st.write(desc)

# ---------------------------
# Page 2: Raw Data
# ---------------------------
elif page == "Raw Data":
    st.title("Raw Athlete Data")
    st.write("You can filter the raw data using the sidebar filters.")
    st.dataframe(filtered_df)
